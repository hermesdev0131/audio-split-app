<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Auto-Cutter</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 2rem;
        }

        /* Upload Screen */
        .upload-area {
            background: #1e293b;
            border: 2px dashed #334155;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-area:hover { border-color: #3b82f6; }
        .upload-area.has-file { border-color: #22c55e; border-style: solid; }
        .upload-area input[type="file"] { display: none; }
        .upload-area .label {
            font-size: 1rem;
            color: #94a3b8;
        }
        .upload-area .filename {
            font-size: 0.875rem;
            color: #22c55e;
            margin-top: 0.5rem;
            word-break: break-all;
        }
        .upload-area .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Blocks Preview */
        .preview {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        .preview h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.75rem;
        }
        .preview-block {
            background: #0f172a;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        .preview-block .hdr { color: #3b82f6; font-weight: 600; }
        .preview-block .txt { color: #cbd5e1; margin-top: 0.25rem; }

        /* Button */
        .btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.875rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1.5rem;
            transition: background 0.2s;
        }
        .btn:hover { background: #2563eb; }
        .btn:disabled { background: #334155; cursor: not-allowed; }

        /* Processing Screen */
        .processing { display: none; }
        .progress-bar-bg {
            background: #1e293b;
            border-radius: 99px;
            height: 12px;
            overflow: hidden;
            margin: 1.5rem 0 1rem;
        }
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            height: 100%;
            border-radius: 99px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .stage {
            font-size: 0.9rem;
            color: #94a3b8;
            text-align: center;
        }
        .log {
            background: #1e293b;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #64748b;
        }
        .log .entry { padding: 0.15rem 0; }
        .log .entry.ok { color: #22c55e; }
        .log .entry.warn { color: #eab308; }
        .log .entry.err { color: #ef4444; }

        /* Results Screen */
        .results { display: none; }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .results-table th {
            text-align: left;
            padding: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
            border-bottom: 1px solid #334155;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .results-table td {
            padding: 0.5rem;
            font-size: 0.85rem;
            border-bottom: 1px solid #1e293b;
        }
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge.ok { background: #052e16; color: #22c55e; }
        .badge.warn { background: #422006; color: #eab308; }
        .badge.low { background: #450a0a; color: #ef4444; }
        .download-btn {
            background: #22c55e;
            margin-top: 1.5rem;
        }
        .download-btn:hover { background: #16a34a; }

        /* Error */
        .error-msg {
            background: #450a0a;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 1rem;
            color: #fca5a5;
            margin-top: 1rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Auto-Cutter</h1>
        <p class="subtitle">Upload audio + HTML to auto-segment by BLOCK sections</p>

        <!-- Upload Screen -->
        <div id="uploadScreen">
            <div class="upload-area" id="audioArea" onclick="document.getElementById('audioInput').click()">
                <div class="icon">&#127925;</div>
                <div class="label">Drop audio file or click to browse</div>
                <div class="label" style="font-size:0.75rem; margin-top:0.25rem">MP3, WAV, M4A, FLAC</div>
                <div class="filename" id="audioName"></div>
                <input type="file" id="audioInput" accept=".mp3,.wav,.m4a,.flac">
            </div>

            <div class="upload-area" id="htmlArea" onclick="document.getElementById('htmlInput').click()">
                <div class="icon">&#128196;</div>
                <div class="label">Drop HTML file or click to browse</div>
                <div class="label" style="font-size:0.75rem; margin-top:0.25rem">HTML, HTM</div>
                <div class="filename" id="htmlName"></div>
                <input type="file" id="htmlInput" accept=".html,.htm">
            </div>

            <div class="preview" id="preview">
                <h3>Detected Blocks: <span id="blockCount">0</span></h3>
                <div id="previewBlocks"></div>
            </div>

            <button class="btn" id="processBtn" disabled onclick="startProcessing()">Process</button>
        </div>

        <!-- Processing Screen -->
        <div class="processing" id="processingScreen">
            <h2 style="text-align:center; margin-bottom:0.5rem">Processing...</h2>
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="stage" id="stageLabel">Initializing...</div>
            <div class="log" id="log"></div>
        </div>

        <!-- Results Screen -->
        <div class="results" id="resultsScreen">
            <h2>Done!</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Block</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
            <button class="btn download-btn" id="downloadBtn" onclick="downloadZip()">Download ZIP</button>
            <button class="btn" style="background:#334155; margin-top:0.75rem" onclick="resetUI()">Process Another</button>
        </div>

        <div class="error-msg" id="errorMsg"></div>
    </div>

    <script>
        let currentJobId = null;
        let pollInterval = null;

        const audioInput = document.getElementById('audioInput');
        const htmlInput = document.getElementById('htmlInput');
        const processBtn = document.getElementById('processBtn');

        audioInput.addEventListener('change', () => {
            const name = audioInput.files[0]?.name;
            document.getElementById('audioName').textContent = name || '';
            document.getElementById('audioArea').classList.toggle('has-file', !!name);
            checkReady();
        });

        htmlInput.addEventListener('change', () => {
            const name = htmlInput.files[0]?.name;
            document.getElementById('htmlName').textContent = name || '';
            document.getElementById('htmlArea').classList.toggle('has-file', !!name);
            checkReady();
        });

        function checkReady() {
            processBtn.disabled = !(audioInput.files[0] && htmlInput.files[0]);
        }

        const STAGE_LABELS = {
            pending: 'Queued...',
            parsing_html: 'Parsing HTML document...',
            transcribing: 'Transcribing audio (this may take a few minutes)...',
            aligning: 'Aligning blocks to audio...',
            cutting: 'Cutting audio segments...',
            packaging: 'Creating ZIP package...',
            completed: 'Done!',
            failed: 'Failed',
        };

        function addLog(text, cls = '') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'entry ' + cls;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        async function startProcessing() {
            const formData = new FormData();
            formData.append('audio', audioInput.files[0]);
            formData.append('html', htmlInput.files[0]);

            document.getElementById('uploadScreen').style.display = 'none';
            document.getElementById('processingScreen').style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
            addLog('Uploading files...');

            try {
                const resp = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Upload failed');
                }
                const data = await resp.json();
                currentJobId = data.job_id;
                addLog(`Job created: ${currentJobId.slice(0, 8)}`, 'ok');
                startPolling();
            } catch (e) {
                showError(e.message);
            }
        }

        function startPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const resp = await fetch(`/api/status/${currentJobId}`);
                    const job = await resp.json();

                    document.getElementById('progressBar').style.width = (job.progress || 0) + '%';
                    document.getElementById('stageLabel').textContent = STAGE_LABELS[job.status] || job.status;

                    if (job.status !== lastStatus) {
                        addLog(STAGE_LABELS[job.status] || job.status, 'ok');
                        lastStatus = job.status;
                    }

                    if (job.block_count && !blockCountLogged) {
                        addLog(`Found ${job.block_count} BLOCK sections`, 'ok');
                        blockCountLogged = true;
                    }

                    if (job.status === 'completed') {
                        clearInterval(pollInterval);
                        addLog('Processing complete!', 'ok');
                        showResults(job);
                    } else if (job.status === 'failed') {
                        clearInterval(pollInterval);
                        showError(job.error || 'Processing failed');
                    }
                } catch (e) {
                    // Polling error, keep trying
                }
            }, 1500);
        }

        let lastStatus = '';
        let blockCountLogged = false;

        function showResults(job) {
            document.getElementById('processingScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            (job.segments || []).forEach(seg => {
                const tr = document.createElement('tr');
                const conf = seg.confidence;
                let badgeClass = 'ok';
                if (conf < 0.5) badgeClass = 'low';
                else if (conf < 0.75) badgeClass = 'warn';

                tr.innerHTML = `
                    <td>${seg.block_id}</td>
                    <td>${seg.header}</td>
                    <td>${formatTime(seg.start_sec)}</td>
                    <td>${formatTime(seg.end_sec)}</td>
                    <td><span class="badge ${badgeClass}">${(conf * 100).toFixed(0)}%</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = (sec % 60).toFixed(2);
            return `${m}:${s.padStart(5, '0')}`;
        }

        function downloadZip() {
            window.location.href = `/api/download/${currentJobId}`;
        }

        function showError(msg) {
            clearInterval(pollInterval);
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            addLog(msg, 'err');
        }

        function resetUI() {
            document.getElementById('uploadScreen').style.display = 'block';
            document.getElementById('processingScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('log').innerHTML = '';
            document.getElementById('audioName').textContent = '';
            document.getElementById('htmlName').textContent = '';
            document.getElementById('audioArea').classList.remove('has-file');
            document.getElementById('htmlArea').classList.remove('has-file');
            audioInput.value = '';
            htmlInput.value = '';
            processBtn.disabled = true;
            currentJobId = null;
            lastStatus = '';
            blockCountLogged = false;
        }
    </script>
</body>
</html>
